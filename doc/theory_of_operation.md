# rosdoc2 Theory of Operation

It might be helpful, in some cases, to understand how this tool functions.

The tool follows these steps:

- Inspect the `package.xml` of the package for any rosdoc2 specific configurations.
  - Note: if none are found, a default configuration which tries to run Sphinx and Doxygen is used.
  - Note: one of the things that the configuration consists of is build stanzas, each represents an instance of a 'builder' and takes the form of `'output subdir': {<settings>}` and are in the 'builders' key.
    - Note: the 'output subdir' is a relative directory in the output directory specified when running the tool.
- Generate the content for the "package header" which will either be in the package index page (if enabled) or included by the user's Sphinx project.
  - Note: this contains standard information about the package, taken from the package.xml and possibly other sources.
- Generate the documentation. For each builder specified (in order defined):
  - Invoke the builder with the associated settings.
    - Note: each builder is given a separate output directory so file collisions do not occur during doc generation.
  - Attempt to move all files generated into a common output directory. If that directory already exists, it will be deleted prior to **rosdoc2** running.
- Generate the package index page.
- Move the resulting files from the common output directory into the output directory specified by the user.
  - Note: this step can overwrite existing files, e.g. files from a previous run of the tool, but will not delete files that are no longer generated by the documentation, so you may want to delete the output directory if you remove or rename parts of the documentation.

Some things to note from the above:

- Since the key of the builder stanzas is the output directory, it is not possible to have more than one builder run in a single output directory.
- Since builders are run in the order defined, if one builder depends on the output of another, you need to define them in the correct order.

## Sphinx Builder

The Sphinx builder will attempt to do a few things to ensure it runs even without any configuration:

- If the `sphinx_sourcedir` is provided, it will assert that it exists and use that.
- If not, it will look for a Sphinx project to exist in the conventional `doc` directory in the root of the package.
- If not, it will set up a temporary Sphinx project and run that against the package.

The final default is in place, even for packages with only C++, so that we can enable cross-referencing between packages using Sphinx and Breathe.

If an existing sphinx project is found, the `conf.py` sphinx configuration will be extended to enable rosdoc2-specific features according to the rosdoc2 configuration.
Additionally, the `project`, `author`, `release` and `version` options are populated from package.xml if they are not specified in `conf.py`.

## Doxygen Builder

The Doxygen builder will attempt to run even with no additional configuration, following these steps:

- If the `doxyfile` setting is provided, it will assert that it exists and use it.
- If not, it will look for a `Doxyfile` in the package's root directory, and use that if it exists.
- If not, it will look for the conventional `include` directory, if it exists it will set up a default Doxygen file and try to document the headers in `include`.

The final default is a best effort to document the headers (assumed to be the public interface for most C++ packages).

